@page "/chat/{SessionId:int}"
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.SignalR.Client
@using ProgressPath.Models
@using ProgressPath.Data
@using ProgressPath.Hubs
@using Microsoft.EntityFrameworkCore
@implements IAsyncDisposable
@inject IChatService ChatService
@inject IStudentSessionService StudentSessionService
@inject IHubNotificationService HubNotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILogger<StudentChat> Logger
@inject IConfiguration Configuration
@inject IDbContextFactory<ProgressPathDbContext> DbContextFactory

@* StudentChat.razor - Main student chat interface page.
   REQ-CHAT-001: Welcome message explaining the goal.
   REQ-CHAT-002: Text message communication with AI tutor.
   REQ-CHAT-005: Messages in chronological order with timestamps.
   REQ-GOAL-007: Progress indicator always visible.
   REQ-GOAL-013: Completion message when 100% reached.
   REQ-GOAL-014: Chat disabled upon completion. *@

<PageTitle>Chat - Progress Path</PageTitle>

<div class="flex-1 flex flex-col" style="min-height: 0; overflow: hidden;">
    @switch (pageState)
    {
        case PageState.Loading:
            <div class="flex-1 flex items-center justify-center">
                <div class="glow-container p-8 text-center">
                    <div class="flex items-center justify-center gap-3">
                        <svg class="animate-spin h-8 w-8" style="color: var(--color-tertiary);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-lg opacity-75">Loading chat...</p>
                    </div>
                </div>
            </div>
            break;

        case PageState.NotFound:
            <div class="flex-1 flex items-center justify-center p-4">
                <div class="glow-container p-8 text-center" style="max-width: 28rem;">
                    <div class="join-page-icon join-page-icon-error mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold gradient-text-pink mb-4">Session Not Found</h1>
                    <p class="text-lg opacity-75">
                        This chat session doesn't exist or you don't have access to it.
                    </p>
                </div>
            </div>
            break;

        case PageState.Active:
            @if (session != null && group != null)
            {
                @* Chat Header with Progress *@
                <div class="flex-shrink-0 px-4 pt-4" style="background: var(--color-dark-bg); backdrop-filter: blur(8px);">
                    <div class="chat-header glow-container p-4">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            @* Group Info *@
                            <div class="flex-1 min-w-0">
                                <h1 class="text-lg font-semibold gradient-text truncate">
                                    @group.Name
                                </h1>
                                <p class="text-sm opacity-75 truncate">
                                    @group.GoalDescription
                                </p>
                            </div>

                            @* Progress Indicator *@
                            <div class="flex-shrink-0">
                                <ProgressIndicator GoalType="group.GoalType"
                                                   CurrentProgress="session.CurrentProgress"
                                                   TotalSteps="group.TotalSteps"
                                                   IsCompleted="session.IsCompleted" />
                            </div>
                        </div>
                    </div>
                </div>

                @* Completion Banner *@
                @if (session.IsCompleted)
                {
                    <div class="mx-4 mt-4 flex-shrink-0">
                        <div class="completion-banner p-4 rounded-xl flex items-center gap-3">
                            <div class="flex items-center justify-center w-10 h-10 rounded-full"
                                 style="background: rgba(255, 255, 255, 0.2);">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-white">Congratulations!</p>
                                <p class="text-sm text-white opacity-90">You have completed your goal!</p>
                            </div>
                        </div>
                    </div>
                }

                @* Chat Messages Area *@
                <div class="flex-1" style="overflow-y: auto; min-height: 0;">
                    @* Welcome message if no messages yet *@
                    @if ((messages == null || !messages.Any()) && !string.IsNullOrEmpty(group.WelcomeMessage))
                    {
                        <div class="p-4">
                            <div class="chat-welcome-message message-bubble message-ai">
                                <div class="flex justify-between items-start mb-2 gap-2">
                                    <span class="text-xs font-medium text-tertiary">AI Tutor</span>
                                </div>
                                <p class="text-sm leading-relaxed whitespace-pre-wrap">@group.WelcomeMessage</p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <ChatMessageList Messages="messages" IsStudentView="true" />
                    }
                </div>

                @* Error Message Display *@
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="mx-4 mb-2 p-3 rounded-lg flex-shrink-0" style="border: 1px solid rgba(255, 107, 157, 0.5); background: rgba(255, 107, 157, 0.1);">
                        <p class="text-sm" style="color: var(--color-primary);">@errorMessage</p>
                    </div>
                }

                @* Chat Input *@
                <div class="p-4 pt-0 flex-shrink-0">
                    <ChatInput OnSendMessage="HandleSendMessage"
                               IsLoading="isSending"
                               IsDisabled="session.IsCompleted" />
                </div>
            }
            break;
    }
</div>

@code {
    /// <summary>
    /// Route parameter: the student session ID from the URL.
    /// </summary>
    [Parameter]
    public int SessionId { get; set; }

    // Component state
    private PageState pageState = PageState.Loading;
    private StudentSession? session;
    private Group? group;
    private List<ChatMessage> messages = new();
    private bool isSending = false;
    private string? errorMessage;

    // SignalR connection
    private HubConnection? hubConnection;
    private CancellationTokenSource? disposalTokenSource;

    /// <summary>
    /// Page states for the UI state machine.
    /// </summary>
    private enum PageState
    {
        Loading,
        NotFound,
        Active
    }

    /// <summary>
    /// Initialize the page by loading session data.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        disposalTokenSource = new CancellationTokenSource();

        try
        {
            // Load session with Group navigation property
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            session = await dbContext.StudentSessions
                .Include(s => s.Group)
                .FirstOrDefaultAsync(s => s.Id == SessionId);

            if (session == null)
            {
                Logger.LogWarning("Student session {SessionId} not found", SessionId);
                pageState = PageState.NotFound;
                return;
            }

            group = session.Group;

            // Load chat history
            var chatHistory = await ChatService.GetChatHistoryAsync(SessionId);
            messages = chatHistory.ToList();

            pageState = PageState.Active;

            Logger.LogInformation(
                "Loaded chat for session {SessionId} (student: {Nickname}, group: {GroupName})",
                SessionId,
                session.Nickname,
                group.Name);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading chat for session {SessionId}", SessionId);
            pageState = PageState.NotFound;
        }
    }

    /// <summary>
    /// Initialize SignalR connection after first render.
    /// JS interop is only available after render in Blazor Server.
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && session != null)
        {
            try
            {
                // Create SignalR hub connection
                hubConnection = new HubConnectionBuilder()
                    .WithUrl(NavigationManager.ToAbsoluteUri("/progresshub"))
                    .WithAutomaticReconnect()
                    .Build();

                // Register event handlers
                RegisterHubEventHandlers();

                // Start the connection
                await hubConnection.StartAsync(disposalTokenSource?.Token ?? CancellationToken.None);

                // Join the student channel
                await hubConnection.InvokeAsync("JoinStudentChannel", SessionId.ToString());

                Logger.LogInformation("Student {SessionId} connected to SignalR hub", SessionId);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to connect to SignalR hub for session {SessionId}", SessionId);
            }
        }
    }

    /// <summary>
    /// Registers SignalR event handlers for real-time updates.
    /// </summary>
    private void RegisterHubEventHandlers()
    {
        if (hubConnection == null) return;

        // ReceiveMessage handler - handles new messages (from other tabs or AI response)
        hubConnection.On<dynamic>(ProgressHub.ClientMethods.ReceiveMessage, (payload) =>
        {
            try
            {
                int messageId = (int)payload.Id;
                string content = (string)payload.Content;
                bool isFromStudent = (bool)payload.IsFromStudent;
                DateTime timestamp = payload.Timestamp;
                bool isOffTopic = payload.IsOffTopic ?? false;
                bool contributesToProgress = payload.ContributesToProgress ?? false;

                // Check if message already exists (avoid duplicates from optimistic UI)
                if (!messages.Any(m => m.Id == messageId))
                {
                    var message = new ChatMessage
                    {
                        Id = messageId,
                        StudentSessionId = SessionId,
                        Content = content,
                        IsFromStudent = isFromStudent,
                        Timestamp = timestamp,
                        IsOffTopic = isOffTopic,
                        ContributesToProgress = contributesToProgress
                    };

                    messages.Add(message);
                    InvokeAsync(StateHasChanged);

                    Logger.LogDebug("Received message {MessageId} via SignalR", messageId);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error handling ReceiveMessage event");
            }
        });

        // ReceiveProgress handler - updates progress state
        hubConnection.On<dynamic>(ProgressHub.ClientMethods.ReceiveProgress, (payload) =>
        {
            try
            {
                int sessionId = (int)payload.SessionId;
                int progress = (int)payload.Progress;
                bool isCompleted = (bool)payload.IsCompleted;

                if (session != null && sessionId == SessionId)
                {
                    session.CurrentProgress = progress;
                    session.IsCompleted = isCompleted;

                    if (isCompleted)
                    {
                        Logger.LogInformation(
                            "Goal completed for session {SessionId} via SignalR",
                            SessionId);
                    }

                    InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error handling ReceiveProgress event");
            }
        });

        // Handle reconnecting state (REQ-RT-002)
        hubConnection.Reconnecting += (exception) =>
        {
            Logger.LogWarning(
                exception,
                "SignalR connection lost for session {SessionId}, attempting to reconnect...",
                SessionId);

            return Task.CompletedTask;
        };

        // Handle reconnection (REQ-RT-003: restore chat history from server)
        hubConnection.Reconnected += async (connectionId) =>
        {
            Logger.LogInformation(
                "SignalR reconnected for session {SessionId}, connection {ConnectionId}",
                SessionId,
                connectionId);

            try
            {
                // Rejoin the student channel
                await hubConnection.InvokeAsync("JoinStudentChannel", SessionId.ToString());

                // Refresh chat history to restore state (REQ-RT-003)
                // Replace messages entirely to avoid duplicates
                var chatHistory = await ChatService.GetChatHistoryAsync(SessionId);
                messages = chatHistory.ToList();

                // Clear any error messages from prior disconnection
                errorMessage = null;

                // Reload session for progress state
                await using var dbContext = await DbContextFactory.CreateDbContextAsync();
                var refreshedSession = await dbContext.StudentSessions
                    .AsNoTracking()
                    .FirstOrDefaultAsync(s => s.Id == SessionId);

                if (refreshedSession != null && session != null)
                {
                    session.CurrentProgress = refreshedSession.CurrentProgress;
                    session.IsCompleted = refreshedSession.IsCompleted;
                }

                await InvokeAsync(StateHasChanged);

                Logger.LogInformation(
                    "State restored after reconnection for session {SessionId}: {MessageCount} messages, {Progress}% progress",
                    SessionId,
                    messages.Count,
                    session?.CurrentProgress ?? 0);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error restoring state after reconnection for session {SessionId}", SessionId);
            }
        };

        // Handle permanent connection loss
        hubConnection.Closed += (exception) =>
        {
            if (exception != null)
            {
                Logger.LogError(
                    exception,
                    "SignalR connection permanently closed for session {SessionId}",
                    SessionId);
            }
            else
            {
                Logger.LogInformation(
                    "SignalR connection closed for session {SessionId}",
                    SessionId);
            }

            return Task.CompletedTask;
        };
    }

    /// <summary>
    /// Handles sending a new message.
    /// Messages are received via SignalR for all tabs including the sender.
    /// REQ-GROUP-020: Multiple tabs for same session receive synchronized updates.
    /// </summary>
    private async Task HandleSendMessage(string content)
    {
        if (string.IsNullOrWhiteSpace(content) || session?.IsCompleted == true)
        {
            return;
        }

        isSending = true;
        errorMessage = null;

        try
        {
            // Send message to server - messages will arrive via SignalR
            // for all tabs including this one (multi-tab sync)
            var aiResponse = await ChatService.SendMessageAsync(SessionId, content);

            Logger.LogDebug(
                "Message sent successfully for session {SessionId}, AI response: {ResponsePreview}",
                SessionId,
                aiResponse.Content.Length > 50 ? aiResponse.Content[..50] + "..." : aiResponse.Content);
        }
        catch (InvalidOperationException)
        {
            // Goal completed - update state
            Logger.LogInformation(
                "Attempted to send message after goal completion for session {SessionId}",
                SessionId);

            if (session != null)
            {
                session.IsCompleted = true;
            }

            // This is not really an error, just indicate completion
            errorMessage = null;
        }
        catch (Exception ex)
        {
            // REQ-AI-022: Display error message on LLM API failure
            Logger.LogError(ex, "Error sending message for session {SessionId}", SessionId);

            errorMessage = "Sorry, I'm having trouble responding right now. Please try again in a moment.";
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Disposes SignalR connection and cleanup resources.
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        disposalTokenSource?.Cancel();
        disposalTokenSource?.Dispose();

        if (hubConnection != null)
        {
            try
            {
                await hubConnection.InvokeAsync("LeaveChannels");
                await hubConnection.DisposeAsync();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Error disposing SignalR connection for session {SessionId}", SessionId);
            }
        }
    }
}
