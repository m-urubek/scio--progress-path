@page "/groups/create"
@attribute [Authorize]
@using System.ComponentModel.DataAnnotations
@using ProgressPath.Models
@using ProgressPath.Models.DTOs
@inject IGroupService GroupService
@inject IAuthenticationService AuthService
@inject IQRCodeService QRCodeService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration

<PageTitle>Create Group - Progress Path</PageTitle>

<div class="container mx-auto py-8 px-4 max-w-3xl">
    <!-- Header -->
    <div class="mb-6">
        <a href="/groups" class="text-sm opacity-75 hover:opacity-100 transition">
            ← Back to Groups
        </a>
    </div>

    @switch (currentStep)
    {
        case Step.Input:
            <!-- Group Creation Form -->
            <div class="glow-container p-8">
                <h1 class="text-3xl font-bold gradient-text mb-6">
                    Create New Group
                </h1>

                <EditForm Model="@formModel" OnValidSubmit="HandleSubmit" FormName="CreateGroupForm">
                    <DataAnnotationsValidator />

                    <!-- Group Name -->
                    <div class="mb-6">
                        <label for="groupName" class="block text-sm font-medium mb-2 opacity-75">
                            Group Name
                        </label>
                        <InputText id="groupName"
                                   @bind-Value="formModel.GroupName"
                                   class="w-full"
                                   placeholder="e.g., A2 - quadratic equations 1"
                                   disabled="@isLoading" />
                        <ValidationMessage For="@(() => formModel.GroupName)" class="text-sm mt-1" style="color: var(--color-primary);" />
                    </div>

                    <!-- Goal Description -->
                    <div class="mb-6">
                        <label for="goalDescription" class="block text-sm font-medium mb-2 opacity-75">
                            Goal Description
                        </label>
                        <InputTextArea id="goalDescription"
                                       @bind-Value="formModel.GoalDescription"
                                       class="w-full h-32 resize-none"
                                       maxlength="500"
                                       placeholder="e.g., independently solve 3 different quadratic equations of the type ax² + bx + c using the discriminant"
                                       disabled="@isLoading" />
                        <div class="flex justify-between items-center mt-1">
                            <ValidationMessage For="@(() => formModel.GoalDescription)" class="text-sm" style="color: var(--color-primary);" />
                            <span class="text-sm character-counter @(formModel.GoalDescription?.Length >= 450 ? "near-limit" : "")">
                                @(formModel.GoalDescription?.Length ?? 0)/500
                            </span>
                        </div>
                    </div>

                    <!-- Error Message -->
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="mb-6 p-4 rounded-lg" style="border: 1px solid rgba(255, 107, 157, 0.5); background: rgba(255, 107, 157, 0.1);">
                            <p class="text-sm" style="color: var(--color-primary);">@errorMessage</p>
                            <button type="button"
                                    class="mt-2 text-sm underline opacity-75 hover:opacity-100"
                                    style="color: var(--color-tertiary);"
                                    @onclick="ClearError">
                                Try Again
                            </button>
                        </div>
                    }

                    <!-- Submit Button -->
                    <button type="submit" class="glow-button w-full" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="flex items-center justify-center gap-2">
                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Interpreting your goal...
                            </span>
                        }
                        else
                        {
                            <span>Create Group</span>
                        }
                    </button>
                </EditForm>
            </div>
            break;

        case Step.Confirmation:
            @if (createdGroup != null && goalInterpretation != null)
            {
                <GoalConfirmation GoalType="@goalInterpretation.GoalType"
                                  Steps="@goalInterpretation.Steps"
                                  WelcomeMessage="@goalInterpretation.WelcomeMessage"
                                  GroupName="@createdGroup.Name"
                                  GoalDescription="@createdGroup.GoalDescription"
                                  OnAccept="HandleAccept"
                                  OnReject="HandleReject"
                                  IsLoading="@isLoading"
                                  ErrorMessage="@errorMessage" />
            }
            break;

        case Step.QRCode:
            @if (createdGroup != null)
            {
                var baseUrl = Configuration["ApplicationBaseUrl"] ?? NavigationManager.BaseUri.TrimEnd('/');
                var joinUrl = $"{baseUrl}/join/{createdGroup.JoinCode}";

                <QRCodeDisplay JoinUrl="@joinUrl" JoinCode="@createdGroup.JoinCode" />

                <div style="margin-top: 1.5rem; margin-bottom: 2rem; text-align: center;">
                    <button class="glow-button" @onclick="NavigateToDashboard">
                        Go to Dashboard
                    </button>
                </div>
            }
            break;
    }
</div>

@code {
    /// <summary>
    /// Represents the current step in the group creation flow.
    /// </summary>
    private enum Step
    {
        Input,
        Confirmation,
        QRCode
    }

    /// <summary>
    /// Form model for group creation input.
    /// </summary>
    private class CreateGroupFormModel
    {
        [Required(ErrorMessage = "Group name is required.")]
        [StringLength(100, ErrorMessage = "Group name cannot exceed 100 characters.")]
        public string GroupName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Goal description is required.")]
        [StringLength(500, ErrorMessage = "Goal description cannot exceed 500 characters.")]
        public string GoalDescription { get; set; } = string.Empty;
    }

    /// <summary>
    /// Current step in the creation flow.
    /// </summary>
    private Step currentStep = Step.Input;

    /// <summary>
    /// Form model instance.
    /// </summary>
    private CreateGroupFormModel formModel = new();

    /// <summary>
    /// Indicates whether an async operation is in progress.
    /// </summary>
    private bool isLoading = false;

    /// <summary>
    /// Error message to display.
    /// </summary>
    private string? errorMessage;

    /// <summary>
    /// The created group (after successful creation).
    /// </summary>
    private Group? createdGroup;

    /// <summary>
    /// The AI's goal interpretation for the current group.
    /// </summary>
    private GoalInterpretation? goalInterpretation;

    /// <summary>
    /// The current user (teacher).
    /// </summary>
    private User? currentUser;

    /// <summary>
    /// Loads the current user on initialization.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUser = await AuthService.GetCurrentUserAsync(authState.User);
    }

    /// <summary>
    /// Handles form submission to create a new group.
    /// </summary>
    private async Task HandleSubmit()
    {
        if (currentUser == null)
        {
            errorMessage = "Unable to identify user. Please sign in again.";
            return;
        }

        errorMessage = null;
        isLoading = true;

        try
        {
            // Create the group with AI interpretation (REQ-GROUP-001)
            createdGroup = await GroupService.CreateGroupAsync(
                formModel.GroupName,
                formModel.GoalDescription,
                currentUser.Id);

            // Get the interpretation for display (REQ-GROUP-008)
            goalInterpretation = await GroupService.GetGoalInterpretationAsync(createdGroup.Id);

            // Move to confirmation step (REQ-GROUP-007)
            currentStep = Step.Confirmation;
        }
        catch (LLMServiceException ex)
        {
            // REQ-GROUP-011: Display error with retry option
            errorMessage = "Failed to interpret your goal. Please try again.";
            Console.WriteLine($"LLM Service error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Handles acceptance of the goal interpretation.
    /// </summary>
    private async Task HandleAccept()
    {
        if (createdGroup == null) return;

        errorMessage = null;
        isLoading = true;

        try
        {
            // Confirm the interpretation (REQ-GROUP-007)
            await GroupService.ConfirmGoalInterpretationAsync(createdGroup.Id);

            // Move to QR code display
            currentStep = Step.QRCode;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to confirm goal: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Handles rejection of the goal interpretation with updated goal description.
    /// </summary>
    /// <param name="updatedGoalDescription">The new goal description to reinterpret.</param>
    private async Task HandleReject(string updatedGoalDescription)
    {
        if (createdGroup == null) return;

        errorMessage = null;
        isLoading = true;

        try
        {
            // Reject and reinterpret (REQ-GROUP-009)
            await GroupService.RejectGoalInterpretationAsync(createdGroup.Id, updatedGoalDescription);

            // Get the new interpretation
            goalInterpretation = await GroupService.GetGoalInterpretationAsync(createdGroup.Id);

            // Update the form model with the new description
            formModel.GoalDescription = updatedGoalDescription;

            // Stay on confirmation step to show new interpretation
        }
        catch (LLMServiceException ex)
        {
            errorMessage = "Failed to reinterpret your goal. Please try again.";
            Console.WriteLine($"LLM Service error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Clears the error message and enables retry.
    /// </summary>
    private void ClearError()
    {
        errorMessage = null;
    }

    /// <summary>
    /// Navigates to the groups dashboard.
    /// </summary>
    private void NavigateToDashboard()
    {
        NavigationManager.NavigateTo("/groups");
    }
}
