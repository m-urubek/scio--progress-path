@using ProgressPath.Models
@inject IChatService ChatService
@inject NavigationManager NavigationManager
@inject ILogger<StudentDetail> Logger

@* Inline modal overlay for full chat view (REQ-DASH-016) *@
@if (showFullChat)
{
    <ChatHistoryModal SessionId="SessionId"
                     Nickname="Nickname"
                     GroupId="GroupId"
                     GoalType="GoalType"
                     TotalSteps="TotalSteps"
                     CurrentProgress="CurrentProgress"
                     IsCompleted="IsCompleted"
                     IsVisible="true"
                     IsEmbedded="false"
                     OnClose="CloseFullChat" />
}

<div class="student-detail">
    @if (isLoading)
    {
        <div class="flex items-center justify-center py-4">
            <svg class="animate-spin h-5 w-5" style="color: var(--color-tertiary);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2 text-sm opacity-75">Loading messages...</span>
        </div>
    }
    else
    {
        <!-- Key Progress Messages Header (REQ-DASH-015) -->
        <div class="mb-3">
            <h4 class="text-sm font-semibold" style="color: var(--color-tertiary);">
                Key Progress Messages
            </h4>
            <p class="text-xs opacity-50">Messages that contributed to goal progress</p>
        </div>

        @if (progressMessages == null || !progressMessages.Any())
        {
            <div class="py-4 text-center">
                <p class="text-sm opacity-50">No progress messages yet.</p>
            </div>
        }
        else
        {
            <div class="space-y-2 max-h-48 overflow-y-auto progress-messages-container">
                @foreach (var message in progressMessages.Take(5))
                {
                    <div class="progress-message-card p-3 rounded-lg"
                         style="background: rgba(34, 211, 216, 0.08); border-left: 3px solid var(--color-tertiary);">
                        <!-- Timestamp -->
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs opacity-50">
                                @message.Timestamp.ToString("MMM dd, HH:mm")
                            </span>
                            @if (message.ContributesToProgress)
                            {
                                <span class="text-xs px-1.5 py-0.5 rounded"
                                      style="background: rgba(34, 211, 216, 0.2); color: var(--color-tertiary);">
                                    Progress
                                </span>
                            }
                        </div>
                        <!-- Message Content -->
                        <p class="text-sm line-clamp-2">@TruncateMessage(message.Content)</p>
                    </div>
                }
            </div>

            @if (progressMessages.Count() > 5)
            {
                <p class="text-xs opacity-50 mt-2">
                    Showing 5 of @progressMessages.Count() progress messages
                </p>
            }
        }

        <!-- View Full Chat Button (REQ-DASH-016) -->
        <div class="mt-4 pt-3" style="border-top: 1px solid rgba(192, 132, 252, 0.15);">
            <button class="view-chat-button w-full"
                    @onclick="ViewFullChat">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                View Full Chat
            </button>
        </div>
    }
</div>

@code {
    /// <summary>
    /// The student session ID to load messages for.
    /// </summary>
    [Parameter]
    public int SessionId { get; set; }

    /// <summary>
    /// The student's nickname for display.
    /// </summary>
    [Parameter]
    public string Nickname { get; set; } = string.Empty;

    /// <summary>
    /// The group ID for navigation.
    /// </summary>
    [Parameter]
    public int GroupId { get; set; }

    /// <summary>
    /// The goal type for this group (passed from parent).
    /// </summary>
    [Parameter]
    public GoalType GoalType { get; set; }

    /// <summary>
    /// Total steps for percentage goals (passed from parent).
    /// </summary>
    [Parameter]
    public int? TotalSteps { get; set; }

    /// <summary>
    /// Current progress (passed from parent).
    /// </summary>
    [Parameter]
    public int CurrentProgress { get; set; }

    /// <summary>
    /// Whether the student has completed the goal (passed from parent).
    /// </summary>
    [Parameter]
    public bool IsCompleted { get; set; }

    private IEnumerable<ChatMessage>? progressMessages;
    private bool isLoading = true;
    private bool showFullChat = false;

    /// <summary>
    /// Loads progress messages when the component initializes or parameters change.
    /// </summary>
    protected override async Task OnParametersSetAsync()
    {
        await LoadProgressMessages();
    }

    /// <summary>
    /// Loads the progress messages for this session (REQ-DASH-015).
    /// </summary>
    private async Task LoadProgressMessages()
    {
        isLoading = true;

        try
        {
            progressMessages = await ChatService.GetProgressMessagesAsync(SessionId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load progress messages for session {SessionId}", SessionId);
            progressMessages = Enumerable.Empty<ChatMessage>();
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Truncates message content for display.
    /// </summary>
    private string TruncateMessage(string content)
    {
        const int maxLength = 150;
        if (string.IsNullOrEmpty(content)) return "";
        if (content.Length <= maxLength) return content;
        return content.Substring(0, maxLength) + "...";
    }

    /// <summary>
    /// Opens the full chat view as an inline modal (REQ-DASH-016).
    /// Alternative: NavigationManager.NavigateTo($"/groups/{GroupId}/students/{SessionId}/chat");
    /// </summary>
    private void ViewFullChat()
    {
        // Show inline modal instead of navigating
        showFullChat = true;
        StateHasChanged();
    }

    /// <summary>
    /// Closes the full chat modal.
    /// </summary>
    private void CloseFullChat()
    {
        showFullChat = false;
        StateHasChanged();
    }
}
